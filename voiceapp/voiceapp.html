<html>
<head>
  <title>Voice Biofeedback</title>
</head>
<body style="background:#aaa; color:#000;">
<pre style="background:#eee;">

asdasd

</pre>

<p>
<canvas id="waterfall" width="800" height="300"></canvas>
</p><p>
<canvas id="spectrum" width="800" height="100"></canvas>
</p><p>
<canvas id="harmonics" width="800" height="100"></canvas>
</p><p>
Fundamental: <input size="5" id="freq"></input>Hz
</p>

<script language="JavaScript"><!--

var fftoff = 20;
var fftout = new Float32Array(1024 * 16);
colorpal = []

function mysleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function run()
{
	var w_canvas = document.getElementById("waterfall");
	var w_ctx = w_canvas.getContext("2d");

	var s_canvas = document.getElementById("spectrum");
	var s_ctx = s_canvas.getContext("2d");

	var h_canvas = document.getElementById("harmonics");
	var h_ctx = h_canvas.getContext("2d");

	w_ctx.fillStyle = "rgb(0,0,0)";
	w_ctx.fillRect(0, 0, w_canvas.width, w_canvas.height);

	w_ctx.fillStyle = "rgb(255,0,0)";
	w_ctx.fillRect(100, 100, w_canvas.width-200, w_canvas.height-200);

	s_ctx.fillStyle = "rgb(0,0,0)";
	s_ctx.fillRect(0, 0, s_canvas.width, s_canvas.height);

	s_ctx.fillStyle = "rgb(255,0,0)";
	s_ctx.fillRect(10, 10, s_canvas.width-20, s_canvas.height-20);

	h_ctx.fillStyle = "rgb(0,0,0)";
	h_ctx.fillRect(0, 0, h_canvas.width, h_canvas.height);

	h_ctx.fillStyle = "rgb(255,0,0)";
	h_ctx.fillRect(10, 10, h_canvas.width-20, h_canvas.height-20);

	for (var i = 0; i < 256; i++)
		colorpal.push("rgb(" + i + "," + i + "," + i + ")");

	var stream = await navigator.mediaDevices.getUserMedia({audio:true});
	// console.log(stream);

	var audioCtx = new window.AudioContext();
	var source = audioCtx.createMediaStreamSource(stream);

	var gainNode = audioCtx.createGain();
	source.connect(gainNode);

	analyser = audioCtx.createAnalyser();
	analyser.smoothingTimeConstant = 0;
	analyser.fftSize = 2*fftout.length;
	gainNode.connect(analyser);
	// console.log(analyser);

	var minmaxval = 0;
	var itcnt = 0;

	while (1)
	{
		itcnt++;
		analyser.getFloatFrequencyData(fftout);

		maxidx = fftoff;
		for (var i = fftoff; i < fftout.length; i++) {
			if (i < maxidx+10) {
				if (fftout[i] > fftout[maxidx])
					maxidx = i;
			} else {
				if (fftout[i] > fftout[maxidx] + 15)
					maxidx = i;
			}
		}

		maxval = fftout[maxidx];

		if (itcnt < 5)
			minmaxval = maxval;

		// console.log(fftout);
		// console.log(maxidx);
		// console.log(maxval, minmaxval);

		if (maxval < -500) {
			await mysleep(50);
			continue;
		}

		if (maxval < minmaxval) {
			minmaxval = maxval;
		} else {
			minmaxval = 0.99*minmaxval + 0.01*maxval;
		}

		if (maxval < minmaxval+20) {
			await mysleep(50);
			continue;
		}

		// scroll by 5 pixels
		w_ctx.putImageData(w_ctx.getImageData(5, 0, w_canvas.width-5, w_canvas.height), 0, 0);

		w_ctx.fillStyle = "#000000";
		w_ctx.fillRect(w_canvas.width-5, 0, 5, w_canvas.height);

		for (var i = 0; i < w_canvas.height; i++)
		{
			v = Math.round(5 * Math.max(0, 20 - maxval + fftout[2*i+fftoff])) +
				Math.round(5 * Math.max(0, 20 - maxval + fftout[2*i+1+fftoff]));
			w_ctx.fillStyle = colorpal[v ? v+50 : 0];
			w_ctx.fillRect(w_canvas.width-3, w_canvas.height-1-i, 5, 1);
			// console.log(w_ctx.fillStyle);
		}

		w_ctx.fillStyle = "#ff0000";
		w_ctx.fillRect(w_canvas.width-5, w_canvas.height-2-(maxidx-fftoff)/2, 3, 3);

		s_ctx.fillStyle = "#000000";
		s_ctx.fillRect(0, 0, s_canvas.width, s_canvas.height);

		s_ctx.fillStyle = "#ff0000";
		for (var i = maxidx; i < s_canvas.width; i+=maxidx) {
			s_ctx.fillRect(i, 0, 1, s_canvas.height);
			s_ctx.fillStyle = "#00ff00";
		}

		s_ctx.beginPath();
		s_ctx.moveTo(0, s_canvas.height);
		for (var i = 1; i < s_canvas.width; i++)
			s_ctx.lineTo(i, -Math.round(fftout[i]));
		s_ctx.strokeStyle = "#ffffff";
		s_ctx.stroke();

		h_ctx.fillStyle = "rgb(0,0,0)";
		h_ctx.fillRect(0, 0, h_canvas.width, h_canvas.height);

		h_ctx.beginPath();
		h_ctx.moveTo(50, 15);
		for (var i = 2; 50*i < h_canvas.width+50 && i*maxidx < fftout.length; i++)
			h_ctx.lineTo(50*i, 95-80*Math.pow(10, (fftout[i*maxidx] - maxval)/20));
		h_ctx.strokeStyle = "#ffffff";
		h_ctx.stroke();

		document.getElementById("freq").value = Math.round(24000 * maxidx / fftout.length);

		await mysleep(200);
	}
};

run();

//--></script>

</body>
</html>
