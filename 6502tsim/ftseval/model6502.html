<script src="../visual6502/segdefs.js"></script>
<script src="../visual6502/transdefs.js"></script>
<script src="../visual6502/nodenames.js"></script>
<script>

document.write("<pre>\n");
document.write("// generated by model6502.html from http://visual6502.org/JSSim/\n");
document.write("#include \"ftseval.h\"\n");

function fmt(text)
{
	var args = arguments;
	function replace_arg(_dummy, i) { return i > 0 ? args[i] : "{"; };
	return text.replace(/\{([0-9]+)\}/g, replace_arg);
}

var allNets = new Array();
var uniqueTransMap = new Object();

for (i in segdefs) {
	netid = segdefs[i][0];
	pullup = segdefs[i][1] == '+';
	if (allNets[netid] == undefined) {
		allNets[netid] = {
			init: 1, supply: 0, neigh: [ ], ccPtr: [ ], ccIdx: [ ], names: [ ]
		};
	}
	if (pullup)
		allNets[netid].init = 3;
}
for (i in nodenames) {
	if (nodenames[i] >= 0)
		allNets[nodenames[i]].names.push(i);
	if (i == "vcc") {
		netid = nodenames[i];
		allNets[netid].init = 3;
		allNets[netid].supply = 1;
	}
	if (i == "vss") {
		netid = nodenames[i];
		allNets[netid].init = 0;
		allNets[netid].supply = 1;
	}
}
for (i in transdefs) {
	var gate = transdefs[i][1];
	var cc1 = transdefs[i][2];
	var cc2 = transdefs[i][3];
	if (uniqueTransMap[gate + ":" + cc1 + ":" + cc2] != undefined)
		continue;
	uniqueTransMap[gate + ":" + cc1 + ":" + cc2] = 1;
	uniqueTransMap[gate + ":" + cc2 + ":" + cc1] = 1;
	if (!allNets[cc1].supply) {
		var idx = allNets[cc1].neigh.length;
		allNets[cc1].neigh.push(cc2);
		allNets[gate].ccPtr.push(cc1);
		allNets[gate].ccIdx.push(idx);
	}
	if (!allNets[cc2].supply) {
		var idx = allNets[cc2].neigh.length;
		allNets[cc2].neigh.push(cc1);
		allNets[gate].ccPtr.push(cc2);
		allNets[gate].ccIdx.push(idx);
	}
}

for (i in allNets) {
	if (allNets[i] == undefined)
		continue;
	document.write(fmt("ftseval_bool_t nol_{1}[{2}];\n", i, allNets[i].neigh.length));
	document.write(fmt("ftseval_netid_t npl_{1}[{2}] = { ", i, allNets[i].neigh.length));
	for (j in allNets[i].neigh)
		document.write(allNets[i].neigh[j] + ", ");
	document.write("};\n");
	document.write(fmt("ftseval_netid_t cpl_{1}[{2}] = { ", i, allNets[i].ccPtr.length));
	for (j in allNets[i].ccPtr)
		document.write(allNets[i].ccPtr[j] + ", ");
	document.write("};\n");
	document.write(fmt("ftseval_neigh_num_t cil_{1}[{2}] = { ", i, allNets[i].ccIdx.length));
	for (j in allNets[i].ccIdx)
		document.write(allNets[i].ccIdx[j] + ", ");
	document.write("};\n");
}

document.write(fmt("ftseval_netid_t ftseval_numNets = {1};\n", allNets.length));
document.write("struct ftseval_net_s ftseval_nets[] = {\n");
for (i = 0; i < allNets.length; i++) {
	if (allNets[i] == undefined) {
		document.write(fmt("\t{ /* unused */ }, // {1}\n", i));
	} else {
		document.write(fmt("\t{ 0, 0, {2}, {2}, 0, {3}, {4}, nol_{1}, npl_{1}, {5}, cpl_{1}, cil_{1} },",
			i, allNets[i].init, allNets[i].supply, allNets[i].neigh.length, allNets[i].ccPtr.length));
		if (allNets[i].names.length > 0) {
			document.write(" //");
			for (j in allNets[i].names)
				document.write(" " + allNets[i].names[j]);
		}
		document.write("\n");
	}
}
document.write("};\n");

document.write("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n");

document.write("// generated by model6502.html from http://visual6502.org/JSSim/\n");
for (i in nodenames) {
	if (nodenames[i] >= 0 && i.match(/^[A-Za-z0-9_]+$/))
		document.write(fmt("#define PIN_{1} {2}\n", i, nodenames[i]));
}

</script>
