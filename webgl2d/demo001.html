<html><head>
<meta charset="utf-8">
<title>WebGL Demo</title>

<!-- ********************* Draw lattice ********************* -->

<script id="lattice-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_position;
uniform float u_scale;
uniform vec2 u_translate, u_resolution;

void main() {
	gl_Position = vec4((2.0 * (a_position * u_scale + u_translate) / u_resolution - 1.0) * vec2(1, -1), 0, 1);
}
</script></script>

<script id="lattice-fragment-shader" type="x-shader/x-fragment">
void main() {
	gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
}
</script>

<script>
function LatticePainter(gl, canvas, w, h) {
	"use strict";
	var program, loc_position, loc_scale, loc_translate, loc_resolution, buffer, data, data_idx, i;

	program = createShaderProgram(gl, "lattice-vertex-shader", "lattice-fragment-shader");
	loc_position = gl.getAttribLocation(program, "a_position");
	loc_scale = gl.getUniformLocation(program, "u_scale");
	loc_translate = gl.getUniformLocation(program, "u_translate");
	loc_resolution = gl.getUniformLocation(program, "u_resolution");
	buffer = gl.createBuffer();

	data = new Float32Array((w + h + 2) * 4);
	data_idx = 0;

	for (i = 0; i <= w; i++) {
		data[data_idx++] = i;
		data[data_idx++] = 0;
		data[data_idx++] = i;
		data[data_idx++] = h;
	}

	for (i = 0; i <= h; i++) {
		data[data_idx++] = 0;
		data[data_idx++] = i;
		data[data_idx++] = w;
		data[data_idx++] = i;
	}

	gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
	gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);

	this.draw = function (x, y, scale) {
		gl.useProgram(program);
		gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
		gl.enableVertexAttribArray(loc_position);
		gl.vertexAttribPointer(loc_position, 2, gl.FLOAT, false, 0, 0);
		gl.uniform1f(loc_scale, scale);
		gl.uniform2f(loc_translate, x, y);
		gl.uniform2f(loc_resolution, canvas.width, canvas.height);
		gl.drawArrays(gl.LINES, 0, 2*(w+h+2));
	}
}
</script>

<!-- ********************* Main ********************* -->

<script>
function createShaderProgram(gl, vertex_shader_id, fragment_shader_id) {
	"use strict";
	var vertex_shader, fragment_shader, program;

	// manage a cache of shader programs within the JavaScript gl object
	if (!("shader_program_cache" in gl))
		gl.shader_program_cache = { };
	if ((vertex_shader_id + ":" + fragment_shader_id) in gl.shader_program_cache)
		return gl.shader_program_cache[vertex_shader_id + ":" + fragment_shader_id];

	vertex_shader = gl.createShader(gl.VERTEX_SHADER);
	gl.shaderSource(vertex_shader, document.getElementById(vertex_shader_id).text);
	gl.compileShader(vertex_shader);

	if (!gl.getShaderParameter(vertex_shader, gl.COMPILE_STATUS))
		throw new Error("Compiler error in vertex shader: " + gl.getShaderInfoLog(vertex_shader));

	fragment_shader = gl.createShader(gl.FRAGMENT_SHADER);
	gl.shaderSource(fragment_shader, document.getElementById(fragment_shader_id).text);
	gl.compileShader(fragment_shader);

	if (!gl.getShaderParameter(fragment_shader, gl.COMPILE_STATUS))
		throw new Error("Compiler error in fragment shader: " + gl.getShaderInfoLog(fragment_shader));

	program = gl.createProgram();
	gl.attachShader(program, vertex_shader);
	gl.attachShader(program, fragment_shader);
	gl.linkProgram(program);

	if (!gl.getProgramParameter(program, gl.LINK_STATUS))
		throw new Error("Linker error: " + gl.getProgramInfoLog (program));

	gl.shader_program_cache[vertex_shader_id + ":" + fragment_shader_id] = program;
	return program;
}

function main() {
	"use strict";
	var canvas, gl, program, painter_1, painter_2;
	var mouse_x, mouse_y, offset_x, offset_y, scale;

	canvas = document.getElementById("canvas");
	gl = canvas.getContext("webgl");

	if (!gl)
		throw new Error("Creating WebGL context failed!");

	mouse_x = 0;
	mouse_y = 0;
	offset_x = 0;
	offset_y = 0;
	scale = 1.0;

	function event_mousewheel(e) {
		var old_scale;

		old_scale = scale;
		if (e.wheelDelta > 0) {
			scale *= 1.1;
		} else {
			scale /= 1.1;
		}

		offset_x -= e.x / old_scale - e.x / scale;
		offset_y -= e.y / old_scale - e.y / scale;
	}

	function event_mousemove(e) {
		if (e.which) {
			offset_x += (e.x - mouse_x) / scale;
			offset_y += (e.y - mouse_y) / scale;
		}
		mouse_x = e.x;
		mouse_y = e.y;
	}

	canvas.addEventListener("mousewheel", event_mousewheel);
	canvas.addEventListener("mousemove", event_mousemove);

	painter_1 = new LatticePainter(gl, canvas, 10, 10);
	painter_2 = new LatticePainter(gl, canvas, 3, 3);

	function draw(time_ms) {
		window.requestAnimationFrame(draw);

		canvas.width = document.body.clientWidth;
		canvas.height = document.body.clientHeight;
		gl.viewport(0, 0, canvas.width, canvas.height);

		painter_1.draw(scale * (offset_x +  20), scale * (offset_y +  20), scale *  10);
		painter_1.draw(scale * (offset_x + 260), scale * (offset_y + 140), scale *  10);
		painter_1.draw(scale * (offset_x + 140), scale * (offset_y + 260), scale *  10);
		painter_2.draw(scale * (offset_x +  10), scale * (offset_y +  10), scale * 120);
	}

	window.requestAnimationFrame(draw);
}

window.onload = main;
</script>

</head>
<body style="overflow: hidden;">
<canvas id="canvas" style="position: absolute; left: 0; top: 0;"></canvas>
</body>
</html>
