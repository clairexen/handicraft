#include <stdint.h>
#include <stdbool.h>

const uint32_t splash_screen_w[] = {
	0b00000000000000000000000000000000,
	0b01111111111111111111111111100000,
	0b01000010000000000000000010010000,
	0b01000010000000000000000010001000,
	0b01000010000000000000000010000100,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000010000000000000000010000010,
	0b01000011111111111111111110000010,
	0b01000000000000000000000000000010,
	0b01000000000000000000000000000010,
	0b01000000000000000000000000000010,
	0b01000000000000000000000000000010,
	0b01000000000000000000000000000010,
	0b01000111111111111111111111100010,
	0b01000100000000000000000000100010,
	0b01000100000000000000000000100010,
	0b01000100101010101010101000100010,
	0b01000100000000000000000000100010,
	0b01000100000000000000000000100010,
	0b01000100010101010101010100100010,
	0b01000100000000000000000000100010,
	0b01000100000000000000000000100010,
	0b01110100101010101010101000100010,
	0b01110100000000000000000000100010,
	0b01000100000000000000000000100010,
	0b01111111111111111111111111111110,
	0b00000000000000000000000000000000
};

const uint32_t splash_screen_g[] = {
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000001111111111111111100000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000
};

const uint32_t splash_screen_l[] = {
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000011111111111111111111000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000000000
};

const uint32_t splash_screen_r[] = {
	0b00000000000000000000000000000000,
	0b01111111111111111111111111100000,
	0b01111101111100000000000001110000,
	0b01111101111100000011110001111000,
	0b01111101111100000011110001111100,
	0b01111101111100000011110001111110,
	0b01111101111100000011110001111110,
	0b01111101111100000011110001111110,
	0b01111101111100000011110001111110,
	0b01111101111100000011110001111110,
	0b01111101111100000011110001111110,
	0b01111101111100000000000001111110,
	0b01111100000000000000000001111110,
	0b01111111111111111111111111111110,
	0b01111111111111111111111111111110,
	0b01111111111111111111111111111110,
	0b01111111111111111111111111111110,
	0b01111111111111111111111111111110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111000000000000000000000011110,
	0b01111111111111111111111111111110,
	0b00000000000000000000000000000000
};

volatile uint32_t *const flashreg = (void*)0x20000050;
bool in_flash_mode = false;

void spi_flash_cs(bool enable)
{
	if (enable)
		*flashreg &= ~8;
	else
		*flashreg |= 8;
}

uint8_t spi_flash_xfer_bit(uint8_t value)
{
	// set or clear MOSI, clock down
	if (value != 0)
		*flashreg = (*flashreg | 2) & ~4;
	else
		*flashreg = (*flashreg & ~2) & ~4;
	
	// sample out bit, clock up
	uint32_t r = *flashreg;
	*flashreg = r | 4;

	return r & 1;
}

uint8_t spi_flash_xfer_byte(uint8_t value)
{
	uint8_t outval = 0, bitmask = 0x80;

	while (bitmask != 0) {
		if (spi_flash_xfer_bit(value & bitmask))
			outval |= bitmask;
		bitmask = bitmask >> 1;
	}

	return outval;
}

static inline void setled(int v)
{
	*(volatile uint32_t*)0x20000000 = v;
}

void setpixel(int x, int y, uint8_t r, uint8_t g, uint8_t b)
{
	if (0 <= x && x < 32 && 0 <= y && y < 32) {
		uint32_t rgb = (r << 16) | (g << 8) | b;
		uint32_t addr = 4*x + 32*4*y + 0x10000000;
		*(volatile uint32_t*)addr = rgb;
	}
}

static void flashscreen()
{
	static int counter = 0;
	counter++;

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (y < 14 || y > 16 || x < 2 || x > 30 || ((x+6) % 8) < 5)
			setpixel(x, y, 0, 0, 0);
		else
		{
			int c = counter;

			if (x < 10)
				c += 1;
			else if (x < 20)
				c += 2;
			else if (x < 30)
				c += 3;

			switch (c % 8) {
				case 0: setpixel(x, y, 255, 0, 0); break;
				case 1: setpixel(x, y, 0, 255, 0); break;
				case 2: setpixel(x, y, 0, 0, 255); break;
				case 3: setpixel(x, y, 255, 255, 0); break;
				case 4: setpixel(x, y, 255, 0, 255); break;
				case 5: setpixel(x, y, 0, 255, 255); break;
				case 6: setpixel(x, y, 10, 10, 10); break;
				case 7: setpixel(x, y, 255, 255, 255); break;
			}
		}
}

static void console_putc(int c)
{
	if (in_flash_mode)
		return;

	*(volatile uint32_t*)0x30000000 = c;
}

static void console_puth(uint32_t v)
{
	if (in_flash_mode)
		return;

	for (int i = 0; i < 8; i++) {
		int d = v >> 28;
		console_putc(d < 10 ? '0' + d : 'a' + d - 10);
		v = v << 4;
	}
}

static void console_puts(const char *s)
{
	if (in_flash_mode)
		return;

	while (*s)
		*(volatile uint32_t*)0x30000000 = *(s++);
}

static int console_getc()
{
	static int load_timeout = 0;

	while (load_timeout < 1000000)
	{
		int c = *(volatile uint32_t*)0x30000000;
		load_timeout++;

		if (c >= 0) {
			load_timeout = 0;
			return c;
		}
	}

	if (!in_flash_mode)
	{
		console_puts("FLASHBOOT ");
		in_flash_mode = true;
		spi_flash_cs(false);
		flashscreen();

		// flash_power_up
		spi_flash_cs(true);
		spi_flash_xfer_byte(0xab);
		spi_flash_cs(false);

		// read data at 256 kB offset
		spi_flash_cs(true);
		spi_flash_xfer_byte(0x03);
		spi_flash_xfer_byte(4);
		spi_flash_xfer_byte(0);
		spi_flash_xfer_byte(0);
	} else
	if (load_timeout++ % 0x1000 == 0)
		flashscreen();

	int c = spi_flash_xfer_byte(0);

	if (c == '*')
	{
		// end of read
		spi_flash_cs(false);

		// flash_power_down
		spi_flash_cs(true);
		spi_flash_xfer_byte(0xb9);
		spi_flash_cs(false);

		return 0;
	}

	return c;
}

bool ishex(char ch)
{
	if ('0' <= ch && ch <= '9') return true;
	if ('a' <= ch && ch <= 'f') return true;
	if ('A' <= ch && ch <= 'F') return true;
	return false;
}

int hex2int(char ch)
{
	if ('0' <= ch && ch <= '9') return ch - '0';
	if ('a' <= ch && ch <= 'f') return ch - 'a' + 10;
	if ('A' <= ch && ch <= 'F') return ch - 'A' + 10;
	return -1;
}

void main()
{
	setled(7); // LEDs OOO

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		setpixel(x, y, 0, 0, 0);

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (splash_screen_g[y] & (1 << (31-x)))
			setpixel(x, y, 64, 64, 64);

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (splash_screen_l[y] & (1 << (31-x)))
			setpixel(x, y, 0, 64, 64);

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (splash_screen_r[y] & (1 << (31-x)))
			setpixel(x, y, 255, 0, 0);

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (splash_screen_w[y] & (1 << (31-x)))
			setpixel(x, y, 255, 255, 255);

	setled(1); // LEDs ..O

	console_puts(".\nBootloader> " + 2);
	uint8_t *memcursor = (uint8_t*)(64 * 1024);
	int bytecount = 0;

	while (1)
	{
		setled(2); // LEDs .O.

		char ch = console_getc();

		setled(3); // LEDs .OO

		if (ch == 0 || ch == '@')
		{
			if (bytecount) {
				console_puts("\nWritten 0x");
				console_puth(bytecount);
				console_puts(" bytes at 0x");
				console_puth((uint32_t)memcursor);
				console_puts(".\nBootloader> ");
			}

			if (ch == 0) {
				in_flash_mode = false;
				console_puts("RUN\n");
				break;
			}

			int newaddr = 0;
			while (1) {
				ch = console_getc();
				if (!ishex(ch)) break;
				newaddr = (newaddr << 4) | hex2int(ch);
			}

			memcursor = (uint8_t*)newaddr;
			bytecount = 0;
			continue;
		}

		setled(4); // LEDs O..

		if (ishex(ch))
		{
			char ch2 = console_getc();

			if (ishex(ch2)) {
				if (bytecount % 1024 == 0)
					console_putc('.');
				memcursor[bytecount++] = (hex2int(ch) << 4) | hex2int(ch2);
				continue;
			}

			console_putc(ch);
			ch = ch2;
			goto prompt;
		}

		setled(5); // LEDs O.O

		if (ch == ' ' || ch == '\t' || ch == '\r' || ch == '\n')
			continue;

	prompt:
		setled(6); // LEDs OO.

		console_putc(ch);
		console_puts(".\nBootloader> " + 1);
	}

	setled(0); // LEDs ...

	for (int x = 0; x < 32; x++)
	for (int y = 0; y < 32; y++)
		if (y < 14 || y > 16 || x < 2 || x > 30 || ((x+6) % 8) < 5)
			setpixel(x, y, 0, 0, 0);
		else
			setpixel(x, y, 255, 255, 255);
}

